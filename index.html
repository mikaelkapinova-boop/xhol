<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Msplomberie Card Game Platform</title>
  <style>
    /* === Reset and base styles for the platform === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #150e27;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    a {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    button {
      cursor: pointer;
    }

    /* === Header common to lobby and game === */
    header {
      background-color: #2b1d4d;
      padding: 12px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 15px rgba(97, 59, 150, 0.7);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 14px;
      user-select: none;
    }

    .user-info img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid #ebcd45;
      object-fit: cover;
    }

    .user-name {
      font-weight: 700;
      font-size: 1.15em;
      color: #f3d451;
    }

    .user-stats {
      display: flex;
      gap: 12px;
      color: #bebaea;
      font-weight: 600;
    }

    nav a {
      margin-left: 20px;
      font-weight: 600;
      padding: 8px 15px;
      border-radius: 6px;
      background: #3c2d7b;
      transition: background-color 0.3s ease;
      text-decoration: none;
      color: #d9d9ff;
      user-select: none;
    }

    nav a:hover,
    nav a:focus {
      background-color: #f7dc5e;
      color: #2e270c;
      outline: none;
    }

    /* === Authentication form container === */
    #auth-container {
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #1a142b;
      padding: 40px 20px;
      gap: 40px;
      flex-direction: column;
      min-height: 90vh;
    }

    .auth-card {
      background-color: #2e2350;
      border-radius: 16px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 0 24px rgba(151, 128, 255, 0.5);
      padding: 36px 30px;
    }

    .auth-card h2 {
      color: #f8ec71;
      font-weight: 700;
      font-size: 2em;
      margin-bottom: 26px;
      text-align: center;
      text-shadow: 0 0 10px #ffd850a3;
      user-select: none;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #ccc9fc;
      user-select: none;
    }

    input[type="email"],
    input[type="password"] {
      width: 100%;
      border-radius: 8px;
      border: none;
      padding: 12px 14px;
      margin-bottom: 22px;
      font-size: 1.05em;
      background-color: #3a2e74;
      color: #eeebff;
      transition: background-color 0.3s ease;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    input[type="email"]:focus,
    input[type="password"]:focus {
      outline: none;
      background-color: #4e408d;
    }

    input[type="submit"],
    button.switch-view {
      width: 100%;
      background-color: #f7d54e;
      border: none;
      padding: 14px 0;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1.15em;
      color: #302900;
      box-shadow: 0 0 15px #f8ee8caa;
      user-select: none;
      transition: background-color 0.3s ease;
      margin-top: 12px;
    }

    input[type="submit"]:hover,
    button.switch-view:hover {
      background-color: #fff182;
    }

    .error-msg,
    .success-msg {
      margin-top: 8px;
      font-weight: 700;
      font-size: 0.9em;
      color: #ff4836;
      user-select: none;
      min-height: 20px;
    }

    .success-msg {
      color: #55ff60;
    }

    /* === Lobby styles === */
    #lobby {
      flex-grow: 1;
      background: linear-gradient(135deg, #2b184a, #13111d);
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 90vh;
    }

    #lobby header {
      width: 100%;
      max-width: 1000px;
      margin-bottom: 40px;
    }

    #lobby .user-info {
      font-size: 1.1em;
    }

    #lobby .modes {
      display: flex;
      gap: 50px;
      justify-content: center;
      max-width: 1000px;
      width: 100%;
    }

    .mode-card {
      flex: 1 1 250px;
      background-color: #3c2f70;
      border-radius: 18px;
      padding: 40px 30px;
      box-shadow: 0 0 28px rgba(95, 60, 162, 0.8);
      color: #e6dcff;
      cursor: pointer;
      text-align: center;
      user-select: none;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

    .mode-card:hover,
    .mode-card:focus {
      transform: scale(1.05);
      box-shadow: 0 0 54px #f7e851aa;
      outline: none;
    }

    .mode-card img {
      width: 100px;
      height: 100px;
      margin-bottom: 24px;
      pointer-events: none;
      user-select: none;
    }

    .mode-title {
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 12px;
      color: #fff37e;
      text-shadow: 0 0 14px #f7e851aa;
    }

    .mode-desc {
      font-size: 1.2em;
      font-weight: 400;
      color: #d7d0fc;
      pointer-events: none;
      user-select: none;
      line-height: 1.4em;
    }

    /* === Game table styles === */
    #game {
      flex-grow: 1;
      background: linear-gradient(135deg, #1b1132, #0d0916);
      padding: 30px 20px 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 90vh;
      user-select: none;
    }

    #game header {
      width: 100%;
      max-width: 1000px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #cdc4ff;
      font-weight: 700;
    }

    #game .user-info {
      font-size: 1.05em;
    }

    #game nav a {
      font-weight: 600;
      padding: 10px 18px;
      border-radius: 8px;
      background-color: #482fa1;
      color: #ceccff;
      user-select: none;
      margin-left: 15px;
      text-decoration: none;
    }

    #game nav a:hover,
    #game nav a:focus {
      background-color: #efe52a;
      color: #281e00;
      outline: none;
      cursor: pointer;
    }

    #game .game-table {
      width: 100%;
      max-width: 1000px;
      background-color: #3a2f69;
      border-radius: 20px;
      padding: 30px 25px 70px;
      box-shadow: 0 0 40px rgba(255,215,50,0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
    }

    #game .table-zones {
      display: flex;
      justify-content: space-between;
      width: 100%;
      gap: 20px;
      margin-bottom: 40px;
      user-select: none;
    }

    .drop-zone {
      flex: 1 1 45%;
      height: 140px;
      background: #5d49a3;
      border-radius: 16px;
      border: 3px dashed #d8c5ff77;
      box-shadow: inset 0 0 20px #c9b5ffaa;
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 15px;
      padding: 10px 12px;
      cursor: default;
    }

    .drop-zone.dragover {
      border-color: #fff16dcc;
      background-color: #fff16d33;
    }

    #game .player-hand {
      width: 100%;
      max-width: 1000px;
      height: 115px;
      background: #371f84;
      border-radius: 16px;
      box-shadow: 0 0 30px rgba(199, 157, 244, .7);
      padding: 16px;
      overflow-x: auto;
      white-space: nowrap;
      user-select: none;
      cursor: default;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .card {
      width: 78px;
      height: 115px;
      background-color: #221a38;
      border-radius: 14px;
      border: 3px solid transparent;
      box-shadow: 0 0 10px rgba(0,0,0,0.7);
      color: white;
      font-weight: 700;
      padding: 6px 10px;
      cursor: grab;
      user-select: none;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      flex-shrink: 0;
      user-drag: element;
    }

    .card.red {
      color: #f4615f;
    }

    .card.dragging {
      opacity: 0.6;
      border-color: #ffe75e;
      box-shadow: 0 0 30px #ffe75e;
      cursor: grabbing;
      user-select: none;
    }

    #xholBtn {
      margin-top: 40px;
      padding: 18px 60px;
      font-size: 1.6em;
      font-weight: 800;
      border-radius: 12px;
      background-color: #ffe55a;
      color: #321e00;
      border: none;
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: 0 0 25px rgba(255,229,90,0.8);
      user-select: none;
      transition: opacity 0.3s ease;
    }

    #xholBtn.enabled {
      opacity: 1;
      cursor: pointer;
      box-shadow: 0 0 40px #ffde59;
    }

    /* Footer */
    footer {
      background-color: #3a295b;
      padding: 22px 20px;
      font-weight: 600;
      font-size: 1em;
      text-align: center;
      color: #c4bbd8;
      user-select: none;
    }

    /* Scrollbar for hands and drop zones */
    ::-webkit-scrollbar {
      height: 9px;
      width: 9px;
    }

    ::-webkit-scrollbar-track {
      background: #2a1e53;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #6d58ad;
      border-radius: 12px;
    }
  </style>
</head>

<body>
  <!-- Authentication container -->
  <section id="auth-container">
    <div class="auth-card" id="loginBox">
      <h2>Connexion</h2>
      <form id="loginForm" autocomplete="off" novalidate>
        <label for="loginEmail">E-mail</label>
        <input id="loginEmail" type="email" autocomplete="username" required />
        <label for="loginPassword">Mot de passe</label>
        <input id="loginPassword" type="password" autocomplete="current-password" minlength="6" required />
        <button type="submit">Se connecter</button>
        <p class="error-msg" id="loginError" aria-live="assertive"></p>
      </form>
      <button class="switch-view" id="showRegisterBtn">Créer un compte</button>
    </div>

    <div class="auth-card hidden" id="registerBox">
      <h2>Créer un compte</h2>
      <form id="registerForm" autocomplete="off" novalidate>
        <label for="registerEmail">E-mail</label>
        <input id="registerEmail" type="email" autocomplete="username" required />
        <label for="registerPassword">Mot de passe (min. 6 caractères)</label>
        <input id="registerPassword" type="password" autocomplete="new-password" minlength="6" required />
        <button type="submit">S'inscrire</button>
        <p class="error-msg" id="registerError" aria-live="assertive"></p>
      </form>
      <button class="switch-view" id="showLoginBtn">Déjà un compte ? Connexion</button>
    </div>
  </section>

  <!-- Lobby screen -->
  <main id="lobbyScreen" class="hidden" aria-label="Ecran principal - Lobby">
    <header>
      <div class="user-info" aria-label="Profil utilisateur">
        <img id="userAvatarLobby" src="" alt="Avatar du joueur" />
        <span class="user-name" id="userNameLobby"></span>
        <div class="user-stats" id="userStatsLobby"></div>
      </div>
      <nav>
        <a href="#" id="logoutLobbyBtn">Déconnexion</a>
      </nav>
    </header>
    <section class="modes">
      <div class="mode-card" tabindex="0" role="button" id="startCasualBtn" aria-label="Mode jeu casual">
        <img src="https://cdn-icons-png.flaticon.com/512/616/616554.png" alt="Mode Casual" />
        <div class="mode-title">Casual</div>
        <div class="mode-desc">Jouez pour le plaisir contre d'autres joueurs !</div>
      </div>
      <div class="mode-card" tabindex="0" role="button" id="startTournamentBtn" aria-label="Mode tournoi">
        <img src="https://cdn-icons-png.flaticon.com/512/616/616601.png" alt="Mode Tournoi" />
        <div class="mode-title">Tournoi</div>
        <div class="mode-desc">Relevez des défis et grimpez dans le classement !</div>
      </div>
    </section>
  </main>

  <!-- Game screen -->
  <main id="gameScreen" class="hidden" aria-label="Ecran principal - Partie de cartes">
    <header>
      <div class="user-info" aria-label="Profil utilisateur">
        <img id="userAvatarGame" src="" alt="Avatar du joueur" />
        <span class="user-name" id="userNameGame"></span>
        <div class="user-stats" id="userStatsGame"></div>
      </div>
      <nav>
        <a href="#" id="quitGameBtn">Quitter la partie</a>
        <a href="#" id="logoutGameBtn">Déconnexion</a>
      </nav>
    </header>
    <section class="game-table" id="gameTable">
      <div class="table-zones">
        <div id="dropZone1" class="drop-zone" aria-label="Zone de dépôt 1"></div>
        <div id="dropZone2" class="drop-zone" aria-label="Zone de dépôt 2"></div>
      </div>
      <div id="playerHand" class="player-hand" aria-label="Main du joueur"></div>
      <button id="xholBtn" disabled>Xhol</button>
    </section>
  </main>

  <footer>
    © 2025 Msplomberie - Jeux de cartes - Tous droits réservés
  </footer>

  <script>
    /* --- Utility and User Management --- */
    const STORAGE_KEY = "msplomberie_users";

    function getUsers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    }

    function saveUsers(users) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
    }

    function hash(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    /* Elements */
    const authContainer = document.getElementById("auth-container");
    const loginBox = document.getElementById("loginBox");
    const registerBox = document.getElementById("registerBox");
    const lobbyScreen = document.getElementById("lobbyScreen");
    const gameScreen = document.getElementById("gameScreen");

    /* Buttons */
    const showRegisterBtn = document.getElementById("showRegisterBtn");
    const showLoginBtn = document.getElementById("showLoginBtn");
    const logoutLobbyBtn = document.getElementById("logoutLobbyBtn");
    const logoutGameBtn = document.getElementById("logoutGameBtn");
    const quitGameBtn = document.getElementById("quitGameBtn");
    const startCasualBtn = document.getElementById("startCasualBtn");
    const startTournamentBtn = document.getElementById("startTournamentBtn");
    const xholBtn = document.getElementById("xholBtn");

    /* Profile displays */
    const userAvatarLobby = document.getElementById("userAvatarLobby");
    const userNameLobby = document.getElementById("userNameLobby");
    const userStatsLobby = document.getElementById("userStatsLobby");

    const userAvatarGame = document.getElementById("userAvatarGame");
    const userNameGame = document.getElementById("userNameGame");
    const userStatsGame = document.getElementById("userStatsGame");

    /* Card zones */
    const dropZone1 = document.getElementById("dropZone1");
    const dropZone2 = document.getElementById("dropZone2");
    const playerHand = document.getElementById("playerHand");

    /* Forms */
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");

    /* Error messages */
    const loginError = document.getElementById("loginError");
    const registerError = document.getElementById("registerError");

    /* Game state */
    let draggedCard = null;
    let currentDeck = [];
    let currentUser = null;

    /* Authentication Handlers */
    showRegisterBtn.addEventListener("click", () => {
      loginBox.classList.add("hidden");
      registerBox.classList.remove("hidden");
      clearMessages();
    });

    showLoginBtn.addEventListener("click", () => {
      registerBox.classList.add("hidden");
      loginBox.classList.remove("hidden");
      clearMessages();
    });

    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      clearMessages();
      const email = loginForm["loginEmail"].value.trim().toLowerCase();
      const password = loginForm["loginPassword"].value;
      const users = getUsers();

      if (!(email in users)) {
        loginError.textContent = "Utilisateur introuvable.";
        return;
      }
      if (users[email].password !== hash(password)) {
        loginError.textContent = "Mot de passe incorrect.";
        return;
      }
      currentUser = email;
      sessionStorage.setItem("mspl_user", email);
      loadUserProfile();
      switchTo("lobby");
    });

    registerForm.addEventListener("submit", e => {
      e.preventDefault();
      clearMessages();
      const email = registerForm["registerEmail"].value.trim().toLowerCase();
      const password = registerForm["registerPassword"].value;
      if (!/\S+@\S+\.\S+/.test(email)) {
        registerError.textContent = "Email invalide.";
        return;
      }
      if (password.length < 6) {
        registerError.textContent = "Mot de passe trop court (6 caractères minimum).";
        return;
      }
      const users = getUsers();
      if (email in users) {
        registerError.textContent = "L'utilisateur existe déjà.";
        return;
      }
      users[email] = {
        password: hash(password),
        profile: {
          pseudo: email.split("@")[0],
          niveau: 1,
          gemmes: 35,
          pieces: 70780
        }
      };
      saveUsers(users);
      currentUser = email;
      sessionStorage.setItem("mspl_user", email);
      loadUserProfile();
      switchTo("lobby");
    });

    /* Switch between views */
    function switchTo(view) {
      clearMessages();
      if (view === "auth") {
        authContainer.style.display = "flex";
        lobbyScreen.classList.add("hidden");
        gameScreen.classList.add("hidden");
      } else if (view === "lobby") {
        authContainer.style.display = "none";
        lobbyScreen.classList.remove("hidden");
        gameScreen.classList.add("hidden");
      } else if (view === "game") {
        authContainer.style.display = "none";
        lobbyScreen.classList.add("hidden");
        gameScreen.classList.remove("hidden");
      }
    }

    /* Clear messages */
    function clearMessages() {
      loginError.textContent = "";
      registerError.textContent = "";
    }

    /* Load user data into UI */
    function loadUserProfile() {
      const users = getUsers();
      if (!(currentUser in users)) {
        switchTo("auth");
        return;
      }
      const profile = users[currentUser].profile;
      const avatarIndex = (profile.pseudo.charCodeAt(0) + profile.niveau) % 99;

      userAvatarLobby.src = `https://randomuser.me/api/portraits/men/${avatarIndex}.jpg`;
      userNameLobby.textContent = profile.pseudo;
      userStatsLobby.innerHTML = `Niv: ${profile.niveau} | 💎 ${profile.gemmes} | 💰 ${profile.pieces}`;

      userAvatarGame.src = userAvatarLobby.src;
      userNameGame.textContent = profile.pseudo;
      userStatsGame.innerHTML = userStatsLobby.innerHTML;
    }

    /* Logout */
    logoutLobbyBtn.addEventListener("click", () => {
      logout();
    });

    logoutGameBtn.addEventListener("click", () => {
      logout();
    });

    function logout() {
      sessionStorage.removeItem("mspl_user");
      currentUser = null;
      switchTo("auth");
    }

    /* Game Controls */
    startCasualBtn.addEventListener("click", () => startGame("casual"));
    startTournamentBtn.addEventListener("click", () => startGame("tournament"));
    quitGameBtn.addEventListener("click", () => quitGame());
    xholBtn.addEventListener("click", () => {
      alert("Xhol action triggered! Hand validated.");
      // Implement full validation per rules here
    });

    /* --- Game Logic --- */

    function createDeck() {
      const suits = ['coeur', 'carreau', 'pique', 'trefle'];
      const values = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'V', 'D', 'R'];
      let deck = [];

      for (let pack = 0; pack < 2; pack++) {
        for (const suit of suits) {
          for (const value of values) {
            deck.push({ value, suit });
          }
        }
      }
      // Add only 2 Jokers total for fairness
      deck.push({ value: 'Joker', suit: 'Joker' });
      deck.push({ value: 'Joker', suit: 'Joker' });

      return deck;
    }

    let draggedCard = null;
    const dropZones = [document.getElementById("dropZone1"), document.getElementById("dropZone2")];
    const playerHand = document.getElementById("playerHand");

    function startGame(mode) {
      switchTo("game");
      clearGame();
      currentDeck = createDeck();
      const { hand, deck } = dealCards(currentDeck, 14);
      currentDeck = deck; // remaining after dealing
      renderHand(hand);
      updateXholState();
    }

    function quitGame() {
      switchTo("lobby");
      clearGame();
    }

    function clearGame() {
      playerHand.innerHTML = "";
      dropZones.forEach(z => z.innerHTML = "");
      xholBtn.disabled = true;
      xholBtn.classList.remove("enabled");
    }

    /* Distribute cards */
    function dealCards(deck, count) {
      deck = deck.sort(() => Math.random() - 0.5);
      const hand = deck.slice(0, count);
      const remainder = deck.slice(count);
      return { hand: hand, deck: remainder };
    }

    /* Render cards in hand */
    function renderHand(cards) {
      playerHand.innerHTML = "";
      cards.forEach((card, idx) => {
        const c = createCardElement(card, idx);
        c.draggable = true;
        playerHand.appendChild(c);
      });
      setupDragAndDrop();
    }

    /* Create a card element visually */
    function createCardElement(card, id) {
      const div = document.createElement("div");
      div.classList.add("card");
      if (card.suit === "coeur" || card.suit === "carreau") div.classList.add("red");
      div.id = `card-${id}`;

      if (card.value === "Joker") {
        div.style.backgroundColor = "#111";
        div.style.color = "yellow";
        div.style.fontSize = "2.8em";
        div.style.textAlign = "center";
        div.style.lineHeight = "100px";
        div.textContent = "🃏";
      } else {
        div.style.backgroundColor = "#28223c";
        div.style.border = card.suit === "coeur" || card.suit === "carreau" ? "3px solid #d33" : "3px solid #ccc";

        const topLeft = document.createElement("div");
        topLeft.textContent = `${card.value}${card.suit === "coeur" ? "♥" : card.suit === "carreau" ? "♦" : card.suit === "pique" ? "♠" : "♣"}`;
        topLeft.style.fontSize = "1.4em";
        topLeft.style.lineHeight = "1.2em";

        const bottomRight = document.createElement("div");
        bottomRight.textContent = topLeft.textContent;
        bottomRight.style.fontSize = "1.4em";
        bottomRight.style.transform = "rotate(180deg)";
        bottomRight.style.lineHeight = "1.2em";

        div.appendChild(topLeft);
        div.appendChild(bottomRight);
      }

      return div;
    }

    /* Setup drag and drop logic */
    function setupDragAndDrop() {
      const cards = playerHand.querySelectorAll(".card");
      cards.forEach(card => {
        card.addEventListener("dragstart", onDragStart);
        card.addEventListener("dragend", onDragEnd);
      });

      dropZones.forEach(zone => {
        zone.addEventListener("dragover", onDragOver);
        zone.addEventListener("drop", onDrop);
        zone.addEventListener("dragleave", onDragLeave);
      });

      playerHand.addEventListener("dragover", onDragOver);
      playerHand.addEventListener("drop", onReturnToHand);
      playerHand.addEventListener("dragleave", onDragLeave);
    }

    function onDragStart(e) {
      draggedCard = e.target;
      e.target.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    }

    function onDragEnd(e) {
      draggedCard.classList.remove("dragging");
      draggedCard = null;
    }

    function onDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add("dragover");
      e.dataTransfer.dropEffect = "move";
    }

    function onDragLeave(e) {
      e.currentTarget.classList.remove("dragover");
    }

    function onDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove("dragover");
      if (draggedCard) {
        e.currentTarget.appendChild(draggedCard);
        updateXholState();
      }
    }

    function onReturnToHand(e) {
      e.preventDefault();
      e.currentTarget.classList.remove("dragover");
      if (draggedCard) {
        playerHand.appendChild(draggedCard);
        updateXholState();
      }
    }

    /* Enable Xhol only if all cards are placed */
    function updateXholState() {
      const count = playerHand.children.length;
      if (count === 0) {
        xholBtn.disabled = false;
        xholBtn.classList.add("enabled");
      } else {
        xholBtn.disabled = true;
        xholBtn.classList.remove("enabled");
      }
    }
  </script>
</body>

</html>
