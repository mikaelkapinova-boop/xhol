<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Msplomberie - Jeux de Cartes Multijoueur</title>

  <style>
    /* Reset et global */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #1b1120;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      user-select: none;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* HEADER */
    header {
      background-color: #2a1f34;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 12px #5d3e84;
      color: #e1cfff;
    }

    header .user-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    header .user-info img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid #ffcf19;
      object-fit: cover;
      user-select: none;
    }

    header .user-info .username {
      font-weight: 700;
      font-size: 1.25rem;
    }

    header .user-stats {
      display: flex;
      gap: 12px;
      font-size: 0.9rem;
      color: #d7caef;
    }

    header .user-stats span {
      display: flex;
      align-items: center;
      gap: 3px;
      user-select: none;
    }

    nav a {
      color: #d7caef;
      text-decoration: none;
      margin-left: 20px;
      font-weight: 600;
      padding: 6px 14px;
      border-radius: 6px;
      transition: background 0.3s ease;
    }

    nav a:hover {
      background-color: #ffcf19;
      color: #230f00;
    }

    /* MAIN avec modes */
    main#modes {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #120817;
      padding: 50px 20px;
    }

    .modes {
      display: flex;
      gap: 60px;
      max-width: 720px;
      width: 100%;
      justify-content: center;
    }

    .mode-card {
      background-color: #382955;
      border-radius: 18px;
      box-shadow: 0 6px 24px #5e4984cc;
      width: 280px;
      cursor: pointer;
      text-align: center;
      padding: 40px 30px 32px;
      border: 2px solid #4e3a70;
      transition: transform 0.2s ease, border-color 0.2s ease;
      user-select: none;
    }

    .mode-card:hover {
      transform: scale(1.06);
      border-color: #ffcf19;
      box-shadow: 0 6px 40px #ffcf19cc;
    }

    .mode-card img {
      height: 72px;
      margin-bottom: 20px;
      filter: drop-shadow(0 1px 3px #0009);
      user-select: none;
    }

    .mode-title {
      font-size: 1.65rem;
      font-weight: 700;
      color: #ffcf19;
      margin-bottom: 14px;
      text-shadow: 0 0 16px #f0d63260;
      user-select: none;
    }

    .mode-desc {
      font-size: 1.1rem;
      color: #c7b8ec;
      line-height: 1.3;
      user-select: none;
    }

    /* TABLE DE JEU */
    main#game {
      flex: 1;
      background: #120817;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 20px 60px;
      min-height: 100vh;
    }

    .game-table {
      position: relative;
      margin: 30px auto 10px;
      background: #2e1e3a;
      border-radius: 26px;
      width: 900px;
      max-width: 95vw;
      padding: 36px 28px 60px;
      box-shadow: 0 0 32px #5e4984cc;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
    }

    .table-areas {
      width: 100%;
      display: flex;
      justify-content: space-around;
      margin-bottom: 34px;
    }

    .drop-zone {
      width: 45%;
      min-height: 140px;
      background: #412e57;
      border-radius: 12px;
      box-shadow: inset 0 0 12px #7d5cc8aa;
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 18px 12px;
      overflow-x: auto;
      border: 2px dashed #6e4db0;
      transition: background-color 0.3s ease;
    }

    .drop-zone.dragover {
      background-color: #ab89fc33;
      border-color: #d0b2fd;
    }

    .player-hand {
      width: 920px;
      max-width: 95vw;
      margin-top: 12px;
      padding: 15px 5px;
      background: #3a285d;
      border-radius: 14px;
      box-shadow: 0 4px 18px #624f90cc;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      user-select: none;
    }

    .card {
      width: 70px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgb(0 0 0 / 0.7);
      cursor: grab;
      user-select: none;
      transition: box-shadow 0.25s ease;
      border: 1px solid transparent;
      flex: 0 0 auto;
      background-size: cover;
      background-position: center;
      height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 6px 8px;
      font-weight: 700;
    }

    .card.dragging {
      opacity: 0.6;
      box-shadow: 0 0 30px 6px #ffcf19;
      cursor: grabbing;
    }

    .card.red {
      color: #d33a3a;
    }

    #xholBtn {
      margin-top: 30px;
      background: #ffd700;
      color: #210;
      border-radius: 10px;
      border: none;
      padding: 14px 60px;
      font-size: 1.4rem;
      font-weight: bold;
      opacity: 0.5;
      cursor: not-allowed;
      user-select: none;
      transition: opacity 0.25s ease;
    }

    #xholBtn.enabled {
      opacity: 1;
      cursor: pointer;
    }

    /* FOOTER */
    footer {
      background: #2e2440;
      padding: 16px;
      text-align: center;
      font-size: 0.9rem;
      color: #c1b2e5cc;
      user-select: none;
    }

    /* AUTH SECTION */
    #auth-section {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #170e22;
      flex-direction: column;
      padding: 50px 20px;
      gap: 24px;
    }

    .auth-box {
      background: #362c51;
      border-radius: 18px;
      padding: 36px 34px;
      box-shadow: 0 5px 38px #4e3d74bb;
      width: 360px;
      max-width: 88vw;
      color: white;
      user-select: none;
    }

    .auth-box h2 {
      font-weight: 700;
      font-size: 1.9rem;
      margin-bottom: 24px;
      letter-spacing: 0.12rem;
      color: #ffcf19;
      text-align: center;
    }

    label {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 6px;
      display: block;
      color: #c6b7f3;
    }

    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px 14px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      outline-offset: 2px;
      outline-color: #a792e0;
      margin-bottom: 18px;
      font-family: inherit;
      user-select: text;
    }

    input[type="submit"],
    button.link-btn {
      width: 100%;
      background: #ffcf19;
      border: none;
      color: #311a04;
      font-weight: 700;
      font-size: 1.15rem;
      border-radius: 10px;
      padding: 14px 0;
      margin-top: 12px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    input[type="submit"]:hover,
    button.link-btn:hover {
      background-color: #fff055;
    }

    button.link-btn {
      background: none;
      color: #99afff;
      text-decoration: underline;
      margin-top: 14px;
      padding: 0;
      border-radius: 0;
      font-weight: 600;
      cursor: pointer;
      user-select: text;
    }

    .error-msg {
      color: #ff6060;
      font-weight: 700;
      font-size: 0.9rem;
      min-height: 20px;
      margin-bottom: 6px;
      user-select: none;
    }

    .success-msg {
      color: #84ff84;
      font-weight: 700;
      font-size: 0.9rem;
      margin-top: 6px;
      user-select: none;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>

  <!-- Authentification -->
  <section id="auth-section">
    <article id="login-box" class="auth-box">
      <h2>Connexion</h2>
      <form id="login-form" autocomplete="off" novalidate>
        <label for="login-email">E-mail</label>
        <input type="email" id="login-email" autocomplete="username" required />
        <label for="login-password">Mot de passe</label>
        <input type="password" id="login-password" autocomplete="current-password" minlength="6" required />
        <input type="submit" value="Se connecter" />
        <p id="login-error" class="error-msg" aria-live="polite"></p>
      </form>
      <button type="button" class="link-btn" onclick="showRegister()">Créer un compte</button>
    </article>

    <article id="register-box" class="auth-box hidden">
      <h2>Créer un compte</h2>
      <form id="register-form" autocomplete="off" novalidate>
        <label for="register-email">E-mail</label>
        <input type="email" id="register-email" autocomplete="username" required />
        <label for="register-password">Mot de passe (6 caractères minimum)</label>
        <input type="password" id="register-password" autocomplete="new-password" minlength="6" required />
        <input type="submit" value="S'inscrire" />
        <p id="register-error" class="error-msg" aria-live="polite"></p>
      </form>
      <button type="button" class="link-btn" onclick="showLogin()">Déjà un compte ? Connexion</button>
    </article>
  </section>

  <!-- ENTRER EN JEU : page d'accueil -->
  <main id="modes" class="hidden">
    <header>
      <div class="user-info" role="region" aria-label="Profil utilisateur">
        <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Avatar utilisateur" id="user-avatar" />
        <span class="username" id="user-pseudo">pseudo</span>
        <div class="user-stats">
          <span title="Niveau">Niv. <strong id="user-level">1</strong></span>
          <span title="Gemmes">💎 <strong id="user-gems">35</strong></span>
          <span title="Pièces">🪙 <strong id="user-coins">70780</strong></span>
        </div>
      </div>

      <nav aria-label="Menu principal">
        <a href="#" title="Accueil" onclick="event.preventDefault()">Accueil</a>
        <a href="#" title="Déconnexion" onclick="logout()">Déconnexion</a>
      </nav>
    </header>

    <div class="modes" role="region" aria-label="Choix des modes de jeu">
      <div class="mode-card" tabindex="0" role="button" aria-label="Mode Casual - jeu pour le plaisir"
        onclick="startGame('casual')">
        <img src="https://cdn-icons-png.flaticon.com/512/616/616554.png" alt="Icône casual" />
        <div class="mode-title">Casual</div>
        <div class="mode-desc">Jouez pour le plaisir contre d'autres joueurs !</div>
      </div>
      <div class="mode-card" tabindex="0" role="button" aria-label="Mode Tournoi - défis et classements"
        onclick="startGame('tournament')">
        <img src="https://cdn-icons-png.flaticon.com/512/616/616601.png" alt="Icône tournoi" />
        <div class="mode-title">Tournoi</div>
        <div class="mode-desc">Relevez des défis et grimpez dans le classement !</div>
      </div>
    </div>
  </main>

  <!-- TABLE DE JEU -->
  <main id="game" class="hidden" role="main" aria-label="Table de jeu">
    <header>
      <div class="user-info" role="region" aria-label="Profil utilisateur">
        <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Avatar utilisateur" id="user-avatar-game" />
        <span class="username" id="user-pseudo-game">pseudo</span>
        <div class="user-stats">
          <span title="Niveau">Niv. <strong id="user-level-game">1</strong></span>
          <span title="Gemmes">💎 <strong id="user-gems-game">35</strong></span>
          <span title="Pièces">🪙 <strong id="user-coins-game">70780</strong></span>
        </div>
        <nav aria-label="Menu principal" style="margin-left:auto;">
          <a href="#" title="Quitter la partie" onclick="quitGame()">Quitter la partie</a>
          <a href="#" title="Déconnexion" onclick="logout()">Déconnexion</a>
        </nav>
      </div>
    </header>

    <div class="game-table" id="game-table">

      <div class="table-areas">
        <div id="drop1" class="drop-zone" aria-label="Zone de pose 1"></div>
        <div id="drop2" class="drop-zone" aria-label="Zone de pose 2"></div>
      </div>

      <div id="player-hand" class="player-hand" aria-label="Main du joueur">
        <!-- Les cartes seront injectées ici -->
      </div>

      <button id="xholBtn" disabled>Xhol</button>
    </div>
  </main>

  <footer>
    © 2025 Msplomberie - Jeux de Cartes Multijoueur - Jeu sans argent réel, sécurisé & gratuit
  </footer>

  <script>
    // Gestion simplifiée des comptes utilisateurs en local storage comme avant
    function getUsers() {
      let list = localStorage.getItem("msplomberie_accounts");
      return list ? JSON.parse(list) : {};
    }
    function saveUsers(accounts) {
      localStorage.setItem("msplomberie_accounts", JSON.stringify(accounts));
    }
    function simpleHash(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    // Afficher boîtes inscription/connexion
    function showRegister() {
      document.getElementById("login-box").classList.add("hidden");
      document.getElementById("register-box").classList.remove("hidden");
      clearErrors();
    }
    function showLogin() {
      document.getElementById("register-box").classList.add("hidden");
      document.getElementById("login-box").classList.remove("hidden");
      clearErrors();
    }
    function clearErrors() {
      document.getElementById("login-error").textContent = "";
      document.getElementById("register-error").textContent = "";
    }

    // Connexion
    document.getElementById("login-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const email = this["login-email"].value.trim().toLowerCase();
      const password = this["login-password"].value;
      const errorElem = document.getElementById("login-error");
      errorElem.textContent = "";
      const users = getUsers();
      if (!users[email]) {
        errorElem.textContent = "Compte introuvable.";
        return;
      }
      if (users[email].password !== simpleHash(password)) {
        errorElem.textContent = "Mot de passe incorrect.";
        return;
      }
      sessionStorage.setItem("activeUser", email);
      loadUserProfile(email);
      showMainSection();
    });

    // Inscription
    document.getElementById("register-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const email = this["register-email"].value.trim().toLowerCase();
      const password = this["register-password"].value;
      const errorElem = document.getElementById("register-error");
      errorElem.textContent = "";
      if (!email.match(/^\S+@\S+\.\S+$/)) {
        errorElem.textContent = "Adresse email invalide.";
        return;
      }
      if (password.length < 6) {
        errorElem.textContent = "Le mot de passe doit contenir au moins 6 caractères.";
        return;
      }
      let users = getUsers();
      if (users[email]) {
        errorElem.textContent = "Ce compte existe déjà.";
        return;
      }
      users[email] = {
        password: simpleHash(password),
        profile: {
          pseudo: email.split("@")[0],
          niveau: 1,
          gemmes: 35,
          pieces: 70780,
        },
      };
      saveUsers(users);
      sessionStorage.setItem("activeUser", email);
      loadUserProfile(email);
      showMainSection();
    });

    // Affichage profil (dans lobby et en jeu)
    function loadUserProfile(email) {
      const users = getUsers();
      if (!users[email]) return;

      const profile = users[email].profile;

      // Lobby
      document.getElementById("user-pseudo").textContent = profile.pseudo;
      document.getElementById("user-level").textContent = profile.niveau;
      document.getElementById("user-gems").textContent = profile.gemmes;
      document.getElementById("user-coins").textContent = profile.pieces;

      // Game
      document.getElementById("user-pseudo-game").textContent = profile.pseudo;
      document.getElementById("user-level-game").textContent = profile.niveau;
      document.getElementById("user-gems-game").textContent = profile.gemmes;
      document.getElementById("user-coins-game").textContent = profile.pieces;

      const avatarIndex = (profile.pseudo.charCodeAt(0) + profile.niveau) % 99;
      // Lobby avatar
      document.getElementById("user-avatar").src = `https://randomuser.me/api/portraits/men/${avatarIndex}.jpg`;
      // Game avatar
      document.getElementById("user-avatar-game").src = `https://randomuser.me/api/portraits/men/${avatarIndex}.jpg`;
    }

    // Afficher la page du lobby
    function showMainSection() {
      document.getElementById("auth-section").style.display = "none";
      document.getElementById("game").classList.add("hidden");
      document.getElementById("modes").classList.remove("hidden");
    }

    // Déconnexion (retour à l’auth)
    function logout() {
      sessionStorage.removeItem("activeUser");
      document.getElementById("auth-section").style.display = "flex";
      document.getElementById("modes").classList.add("hidden");
      document.getElementById("game").classList.add("hidden");
      clearErrors();
    }

    // Quitter la partie pour revenir au lobby
    function quitGame() {
      document.getElementById("game").classList.add("hidden");
      document.getElementById("modes").classList.remove("hidden");
      clearGameTable();
    }

    // Chargement session active au chargement page
    window.addEventListener("load", () => {
      const activeUser = sessionStorage.getItem("activeUser");
      if (activeUser) {
        loadUserProfile(activeUser);
        showMainSection();
      }
    });

    // =======================
    // LOGIQUE DU JEU & TABLE
    // =======================

    // Création d’un deck avec 2 paquets sans jokers plus 2 jokers au total
    function createDeck() {
      const suits = ['coeur', 'carreau', 'pique', 'trefle'];
      const values = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'V', 'D', 'R'];

      let deck = [];

      // 2 paquets sans jokers
      for (let pack = 0; pack < 2; pack++) {
        for (const suit of suits) {
          for (const value of values) {
            deck.push({ value, suit });
          }
        }
      }

      // 2 jokers seulement au total
      deck.push({ value: 'Joker', suit: 'Joker' });
      deck.push({ value: 'Joker', suit: 'Joker' });

      return deck;
    }

    // Création visuelle carte (fond, texte simple)
    function createCardElement(cardObj, id) {
      const div = document.createElement("div");
      div.classList.add("card");
      div.setAttribute("draggable", "true");
      div.id = `card-${id}`;

      if (cardObj.value === 'Joker') {
        div.style.backgroundColor = "#111";
        div.style.color = "yellow";
        div.textContent = "🃏";
        div.style.fontSize = "2.8rem";
        div.style.textAlign = "center";
        div.style.lineHeight = "100px";
        div.style.userSelect = "none";
      } else {
        let cardColor = '#fff';
        if (cardObj.suit === 'coeur' || cardObj.suit === 'carreau') {
          cardColor = '#d33a3a';
          div.classList.add('red');
        }
        div.style.backgroundColor = "#28223c";
        div.style.border = `2px solid ${cardColor}`;
        div.style.color = cardColor;

        // Contenu texte haut-gauche et bas-droite
        const topLeft = document.createElement("div");
        topLeft.textContent = `${cardObj.value} ${cardObj.suit === 'coeur' ? '♥' : cardObj.suit === 'carreau' ? '♦' : cardObj.suit === 'pique' ? '♠' : '♣'}`;
        topLeft.style.fontSize = "1.6rem";
        topLeft.style.lineHeight = "1.1";
        div.appendChild(topLeft);

        const bottomRight = document.createElement("div");
        bottomRight.textContent = topLeft.textContent;
        bottomRight.style.fontSize = "1.6rem";
        bottomRight.style.alignSelf = "flex-end";
        bottomRight.style.transform = "rotate(180deg)";
        bottomRight.style.lineHeight = "1.1";
        bottomRight.style.userSelect = "none";
        div.appendChild(bottomRight);
      }
      return div;
    }

    let handCardsElements = [];

    // Distribuer 14 cartes mélangées pour la main
    function dealInitialCards(deck) {
      deck = deck.sort(() => Math.random() - 0.5);
      const hand = deck.slice(0, 14);
      return { hand, remainingDeck: deck.slice(14) };
    }

    // Afficher cartes en main
    function renderHandCards(hand) {
      const handDiv = document.getElementById("player-hand");
      handDiv.innerHTML = "";
      handCardsElements = [];
      hand.forEach((card, idx) => {
        const cardEl = createCardElement(card, idx);
        handDiv.appendChild(cardEl);
        handCardsElements.push(cardEl);
      });
      addDragDropListeners();
    }

    // Setup drag & drop
    function addDragDropListeners() {
      handCardsElements.forEach(cardEl => {
        cardEl.addEventListener("dragstart", dragStart);
        cardEl.addEventListener("dragend", dragEnd);
      });

      const dropZones = document.querySelectorAll(".drop-zone");
      dropZones.forEach(zone => {
        zone.addEventListener("dragover", dragOver);
        zone.addEventListener("drop", dropCard);
        zone.addEventListener("dragleave", dragLeave);
      });

      const handDiv = document.getElementById("player-hand");
      handDiv.addEventListener("dragover", dragOver);
      handDiv.addEventListener("drop", returnToHand);
      handDiv.addEventListener("dragleave", dragLeave);
    }

    let draggedCard = null;

    function dragStart(e) {
      draggedCard = this;
      this.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    }

    function dragEnd(e) {
      this.classList.remove("dragging");
      draggedCard = null;
    }

    function dragOver(e) {
      e.preventDefault();
      this.classList.add("dragover");
      e.dataTransfer.dropEffect = "move";
    }

    function dragLeave(e) {
      this.classList.remove("dragover");
    }

    function dropCard(e) {
      e.preventDefault();
      this.classList.remove("dragover");
      if (draggedCard) {
        this.appendChild(draggedCard);
        checkAllCardsPlaced();
      }
    }

    function returnToHand(e) {
      e.preventDefault();
      this.classList.remove("dragover");
      if (draggedCard) {
        this.appendChild(draggedCard);
        checkAllCardsPlaced();
      }
    }

    const xholBtn = document.getElementById("xholBtn");

    function checkAllCardsPlaced() {
      const handDiv = document.getElementById("player-hand");
      if (handDiv.children.length === 0) {
        xholBtn.disabled = false;
        xholBtn.classList.add("enabled");
      } else {
        xholBtn.disabled = true;
        xholBtn.classList.remove("enabled");
      }
    }

    xholBtn.addEventListener("click", () => {
      alert("Xhol activé : la main est prête !");
      // Logique de validation à ajouter ici
    });

    function clearGameTable() {
      document.getElementById("player-hand").innerHTML = "";
      document.getElementById("drop1").innerHTML = "";
      document.getElementById("drop2").innerHTML = "";
      xholBtn.disabled = true;
      xholBtn.classList.remove("enabled");
    }

    function startGame(mode) {
      document.getElementById("modes").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      clearGameTable();
      const deck = createDeck();
      const { hand } = dealInitialCards(deck);
      renderHandCards(hand);
      checkAllCardsPlaced();
    }

    function quitGame() {
      document.getElementById("game").classList.add("hidden");
      document.getElementById("modes").classList.remove("hidden");
      clearGameTable();
    }
  </script>
</body>

</html>
